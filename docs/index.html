<!DOCTYPE html>
<html>
    <head>
        <title>新型コロナウィルス都道府県別感染者数の傾向</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta property="og:title" content="新型コロナウィルス都道府県別感染者数の傾向"/>
        <meta property="og:description" content="4/10 新型コロナウィルスの都道府県別感染者数グラフ一覧"/>
        <meta property="og:image" content="https://kishida.github.io/covid19/map.png"/>
        <meta property="og:url" content="https://kishida.github.io/covid19/"/>
        <meta name="twitter:card" content="summary"/>
        <meta name="twitter:site" content="@kis"/>
    </head>
    <body>
        <h1>新型コロナウィルス都道府県別感染者数の傾向</h1>
        <div>
            Naoki Kishida(<a href="https://twitter.com/kis">@kis</a>) Last Update: <span id="update"></span><br/>
        </div>
        <div style="display: inline-block">
        <div id="map"></div>
        (赤: 感染拡大中, 緑: 感染収れん)
        </div>
        <div style="display: inline-block; max-width: 550px; max-height: 300px; min-width: 550px; min-height: 300px;">
            <canvas id="bar"></canvas>
        </div>
        <div style="display:block"></div>
        <div>
            <input type="radio" id="type1" name="type" value="1" checked><label for="type1">感染者+死亡者</label>
            <input type="radio" id="type2" name="type" value="2"><label for="type2">感染者</label>
            <input type="radio" id="type3" name="type" value="3"><label for="type3">死亡者</label>
        </div>
        <div>
            <input type="radio" id="axis1" name="axis" value="1" checked><label for="axis1">線形軸</label>
            <input type="radio" id="axis2" name="axis" value="2"><label for="axis2">対数軸</label>
        </div>
        <div id="data" style="display: table;">
            
        </div>
        <div>
            データは <a href="https://www.mhlw.go.jp/stf/seisakunitsuite/bunya/0000121431_00086.html">厚生労働省のサイト</a>の3/8発表分以降。死者は3/20から<br/>
            日時は発表日時。3/29より前は患者数であったのが感染者数に変わったためギャップがある。<br/>
            福岡県は4/1以降は厚生労働省の集計値ではなく県の発表値を使っている。
        </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.7.2/Chart.bundle.js"></script>
    <script src="jquery.japan-map.min.js"></script>
    <script src="prefs.js"></script>
    <script>
        $("#update").text(data.lastUpdate);
        var c = $("#data");
        var row = $('<div style="display: table-row"></div>');
        var firstrow = row;
        var x = 1;
        var areas = [];
        var charts = [];
        var total = Array(data.prefs[0].patients.length);
        total.fill(0);
        var motarity = Array(data.prefs[0].motarity.length);
        motarity.fill(0);
        data.prefs.forEach(pref => {
            var slice = pref.patients.slice(-3);
            
            for (var i = 0; i < pref.patients.length; ++i) {
                total[i] += pref.patients[i];
                motarity[i] += pref.motarity[i];
            }
            
            // map data
            var pre = slice[0];
            var post = slice[2];
            var rate;
            const thresould = 1.5;
            if (pre === 0) {
                if (post > 0) {
                    rate = thresould;
                } else {
                    rate = 1;
                }
            } else {
                rate = post / pre;
            }
            if (rate > thresould) {
                rate = 1;
            } else {
                rate = (Math.sqrt(rate) - 1) / (Math.sqrt(thresould) - 1);
            }
            if (rate < 0) {
                rate = 0;
            }
            areas.push({
                code: pref.code,
                jp: pref.pref,
                color: "rgba(" + Math.floor(255 * rate) + "," + Math.floor(255 * (1-rate)) + ",0,.7)",
                prefectures: [pref.code]
            });
            
            var div = $('<div style="max-width: 200px; max-height: 200px; min-width: 200px; min-height: 200px; display: table-cell"></div>');
            var prefName = $('<div></div>');
            var motal = pref.motarity.slice(-1)[0];
            prefName.text(pref.pref + "(感染:" + post + " 死者:" + motal + ")");
            div.append(prefName);
            var canv =  $('<canvas></canvas');
            div.append(canv);
            row.append(div);
        
            //var canv = document.getElementById(pref.pref);
            var ctx = canv.get(0).getContext("2d");
            var chart = new Chart(ctx, {
               type: 'line',
               data: {
                   labels: pref.dates,
                   datapool: [{
                           label: "感染者",
                           data: pref.patients,
                           backgroundColor: "rgba(153,255,51,0.4)",
                           pointRadius: 0,
                           pointHitRadius: 3
                        },
                        {
                           label: "死者",
                           data: pref.motarity,
                           backgroundColor: "rgba(255,53,51,1)",
                           pointRadius: 0,
                           pointHitRadius: 3
                            
                        }
                   ]
               },
               options: {
                   legend: {
                       display: false
                   },
                   scales: {
                       yAxes: [{
                               ticks: {
                                   beginAtZero: true
                               },
                               type: 'linear'
                       }],
                       xAxes: [{
                           display: false
                       }]

                   }
               }
            });
            chart.data.datasets = chart.data.datapool;
            chart.update();
            charts.push(chart);
            ++x;
            if (x == 5) {
                x = 0;
                c.append(row);
                row = $('<div style="display: table-row"></div>');
            }
        });
        if (x > 0) {
            c.append(row);
        }
        
        var div = $('<div style="max-width: 200px; max-height: 200px; min-width: 200px; min-height: 200px; display: table-cell"></div>');
        var prefName = $('<div></div>');
        var post = total.slice(-1)[0];
        var mot = motarity.slice(-1)[0];
        prefName.text("全国(感染:" + post + " 死者:" + mot + ")");
        div.append(prefName);
        var canv =  $('<canvas></canvas');
        div.append(canv);
        row.append(div);

        //var canv = document.getElementById(pref.pref);
        var ctx = canv.get(0).getContext("2d");
        var chart = new Chart(ctx, {
           type: 'line',
           data: {
               labels: data.prefs[0].dates,
               datapool: [{
                       label: "感染者",
                       data: total,
                       backgroundColor: "rgba(153,255,51,0.4)",
                       pointRadius: 0,
                       pointHitRadius: 3
                    },
                    {
                       label: "死者",
                       data: motarity,
                       backgroundColor: "rgba(255,53,51,1)",
                       pointRadius: 0,
                       pointHitRadius: 3

                    }]
           },
           options: {
               legend: {
                   display: false
               },
               scales: {
                   yAxes: [{
                           ticks: {
                               beginAtZero: true
                           },
                           type: 'linear'
                   }],
                   xAxes: [{
                       display: false
                   }]

               }
           }
        });
        chart.data.datasets = chart.data.datapool;
        chart.update();
        charts.push(chart);
        firstrow.prepend(div);
        
        $("#map").japanMap({
            areas: areas,
            movesIslands: true,
            height: 300
        });
        var prefsChart = new Chart(document.getElementById("bar").getContext("2d"), {
            type: 'bar',
            data: {
                labels: latest.prefs,
                datasets: [{
                        label: "感染者数",
                        data: latest.patients,
                        backgroundColor: "rgba(0, 255, 0, 0.5)"
                }]
            },
            options: {
                legend: {
                   display: false
               }
            }
        });
        
        $('input[name="type"]:radio').change(function(){
            charts.forEach(ch => {
                switch ($(this).val()) {
                    case '1':
                        ch.data.datasets = [ch.data.datapool[0], ch.data.datapool[1]];
                        break;
                    case '2':
                        ch.data.datasets = [ch.data.datapool[0]];
                        break;
                    case '3':
                        ch.data.datasets = [ch.data.datapool[1]];
                        break;
                }
                ch.update();
            });
        });
        
        $('input[name="axis"]:radio').change(function() {
            var type = 'linear';
            if ($(this).val() === '2') {
                type = 'logarithmic';
            }
            charts.forEach(ch => {
                ch.options.scales.yAxes[0].type = type;
                ch.update();
            });
            prefsChart.options.scales.yAxes[0].type = type;
            prefsChart.update();
        });
    </script>
    </body>
</html>
